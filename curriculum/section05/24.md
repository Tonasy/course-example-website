CI/CD
==

- この講義では、GitHub Actionsを使って、自動コードチェック・自動デプロイを行う方法を学びます。
- GitHub Actions は、ビルド、テスト、デプロイのパイプラインを自動化できる、CI/CDのプラットフォームです。
- GitHub Actionの詳しい使い方については、公式ドキュメントの[GitHub Actions を理解する](https://docs.github.com/ja/actions/learn-github-actions/understanding-github-actions)などを見て確認してください。

## 自動コードチェック・自動デプロイの設定

- `.github/workflows/`に`lint.yml`を作成します。
- これはbranchが`main`にpushされたときに、`npm run lint:html`を実行する設定となります。
- GitHubにプルリクエストを作成すると、GitHub Actionsが自動で実行されます。コードを更新するたびにチェックが走るようになるため、コードの品質を保つことができます。特に共同で作業をする場合には、非常に便利です。
- package.jsonの`scripts`に設定されているコマンドであれば、実行可能です。

```yml
name: lint

on:
  pull_request:
    branches: [main]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Setup Node.js
      - name: Setup Node.js environment
        uses: actions/setup-node@v3

      # Run scripts
      - name: Install dependencies
        run: npm install
      - name: linting
        run: npm run lint:html
```

なおCDに相当する箇所はVercelと連携すると自動的に実行してくれます。以下がその表示のサンプルです。

![GitHubのPR画面。"The latest updates on your projects. Learn more about Vercel for Git"と表示されている。Vercelのデプロイ先URLも合わせて表示されている。](https://user-images.githubusercontent.com/4032232/226160678-409e72bb-92ab-477f-9f16-ea2970112e7f.png)

## Storybookを同時公開

- ちょっとしたテクニックとして、ウェブサイトと同時にStorybookを公開する手順も紹介します。
- 通常Storybookはビルドすると`/storybook-static`というディレクトリに公開されるため、Vercel上で同時に公開はできません。
- しかし、コマンドと`Vercel.json`というVercel用設定ファイルを使うことで、Astroファイルのビルドと同時にStorybookをビルド、公開することが可能です。
- 設定すると`https://xxx.vercel.app/_storybook/`のURLでStorybookが確認可能となります。

### package.json

更新箇所のみ抜粋しています。

```json
"scripts": {
  "build": "astro build && npm run build-storybook",
  "build-storybook": "storybook build -o dist/_storybook"
}
```

### vercel.json

`vercel.json`はリポジトリのルートディレクトリに設置してください。


```json
{
  "redirects": [
    {
      "source": "/_storybook",
      "destination": "/_storybook/"
    }
  ]
}
```


## 参考

- [Actions | GitHub](https://github.co.jp/features/actions)
- [GitHubの新機能「GitHub Actions」で試すCI/CD](https://knowledge.sakura.ad.jp/23478/)
